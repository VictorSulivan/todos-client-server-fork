name: smoke-test

on:
  workflow_run:
    workflows: ["deploy-frontend", "deploy-backend"]
    types:
      - completed

jobs:
  smoke-test:
    name: Smoke tests after deployment
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test frontend
        run: |
          FRONTEND_URL="${{ secrets.FRONTEND_URL }}"
          if [ -z "$FRONTEND_URL" ]; then
            echo "⚠️ FRONTEND_URL secret not set, skipping frontend test"
            exit 0
          fi
          echo "Testing frontend at $FRONTEND_URL"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL" || echo "000")
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
            echo "✅ Frontend is responding (HTTP $HTTP_CODE)"
          else
            echo "❌ Frontend test failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Test backend API
        run: |
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          if [ -z "$BACKEND_URL" ]; then
            echo "⚠️ BACKEND_URL secret not set, skipping backend test"
            exit 0
          fi
          echo "Testing backend at $BACKEND_URL"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/api/todos" || echo "000")
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
            echo "✅ Backend API is responding (HTTP $HTTP_CODE)"
          else
            echo "❌ Backend API test failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Test backend health
        run: |
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          if [ -z "$BACKEND_URL" ]; then
            echo "⚠️ BACKEND_URL secret not set, skipping health check"
            exit 0
          fi
          echo "Testing backend health at $BACKEND_URL"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL" || echo "000")
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 500 ]; then
            echo "✅ Backend is reachable (HTTP $HTTP_CODE)"
          else
            echo "❌ Backend health check failed (HTTP $HTTP_CODE)"
            exit 1
          fi

